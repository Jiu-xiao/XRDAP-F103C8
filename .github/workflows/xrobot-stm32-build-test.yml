name: xrobot stm32 build test

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/xrobot-org/docker-image-stm32:main
      options: --user 0
    env:
      GCC_TOOLCHAIN_ROOT: /opt/arm-gnu-toolchain-14.2.rel1-x86_64-arm-none-eabi/bin
      CLANG_GCC_CMSIS_COMPILER: /opt/st-arm-clang
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: mark workspace safe
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: configure cmake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE:STRING=cmake/starm-clang.cmake \
            -DCMAKE_BUILD_TYPE:STRING=Release

      - name: build
        run: cmake --build build --parallel

      - name: package firmware
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          OBJCOPY_BIN=""
          if command -v starm-objcopy >/dev/null 2>&1; then
            OBJCOPY_BIN="starm-objcopy"
          elif command -v arm-none-eabi-objcopy >/dev/null 2>&1; then
            OBJCOPY_BIN="arm-none-eabi-objcopy"
          fi

          for MODE in 72m 96m; do
            FW_DIR="build/XRDAP_F103C8_clock_${MODE}"
            ELF_PATH="${FW_DIR}/XRDAP-F103C8.elf"
            MAP_PATH="${FW_DIR}/XRDAP-F103C8.map"
            FW_NAME="XRDAP-F103C8-${MODE}"

            if [ ! -f "$ELF_PATH" ]; then
              echo "Missing firmware: $ELF_PATH"
              exit 1
            fi

            cp "$ELF_PATH" "dist/${FW_NAME}.elf"
            if [ -f "$MAP_PATH" ]; then
              cp "$MAP_PATH" "dist/${FW_NAME}.map"
            fi

            if [ -n "$OBJCOPY_BIN" ]; then
              "$OBJCOPY_BIN" -O ihex "$ELF_PATH" "dist/${FW_NAME}.hex"
              "$OBJCOPY_BIN" -O binary "$ELF_PATH" "dist/${FW_NAME}.bin"
            else
              echo "objcopy not found, skip generating .hex/.bin for ${FW_NAME}"
            fi
          done

          PKG_TAG="${GITHUB_REF_NAME:-snapshot}"
          PKG_NAME="XRDAP-F103C8-${PKG_TAG}.tar.gz"
          TMP_PKG="${RUNNER_TEMP:-/tmp}/${PKG_NAME}"
          tar -C dist --exclude='*.tar.gz' -czf "${TMP_PKG}" .
          mv "${TMP_PKG}" "dist/${PKG_NAME}"

      - name: upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.sha }}
          path: |
            dist/*.elf
            dist/*.hex
            dist/*.bin
            dist/*.map
            dist/*.tar.gz
          if-no-files-found: error

  release:
    if: github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: release metadata
        id: meta
        shell: bash
        run: |
          DATE_UTC="$(date -u +'%Y-%m-%d')"
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          echo "release_name=${DATE_UTC}" >> "$GITHUB_OUTPUT"
          echo "tag_name=release-${DATE_UTC}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: download firmware artifact
        uses: actions/download-artifact@v4
        with:
          name: firmware-${{ github.sha }}
          path: dist

      - name: publish release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.meta.outputs.release_name }}
          tag_name: ${{ steps.meta.outputs.tag_name }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: |
            dist/*.elf
            dist/*.hex
            dist/*.bin
            dist/*.map
            dist/*.tar.gz
